# CR\_Reflectometry

*MATLAB-проект для автоматизации измерений и анализа в когерентной рефлектометрии (COTDR) с использованием ADLINK PCIe‑9852, внешних термоконтроллеров и гибкой структуры скриптов.*

---

## Содержание

1. [Общее описание](#about)
2. [Структура проекта](#structure)
3. [Основные сценарии работы](#workflow)
4. [Управление оборудованием](#hardware)
5. [Съёмка и обработка данных](#acquire)
6. [Обработка и сравнение экспериментов](#analysis)
7. [Утилиты и полезные скрипты](#utils)
8. [Часто задаваемые вопросы](#faq)
9. [Авторы и поддержка](#authors)

---

## <a name="about"></a>1. Общее описание

Этот проект предназначен для:

* **Автоматизации управления когерентным волоконным рефлектометром** (COTDR);
* **Съёмки и контроля качества больших массивов рефлектограмм** с возможностью температурного сканирования;
* **Анализа данных, корреляций, генерации тепловых карт и сравнения экспериментов**;
* Удобной интеграции с библиотеками управления АЦП от ADLINK и внешними контроллерами (термоконтроль, тактогенератор).

**Поддерживаемые платформы:** Windows, MATLAB R2016b+ (желательно).

---

## <a name="structure"></a>2. Структура проекта

```
CR_Reflectometry/
│
├── adlink/                    # Скрипты и либы для работы с ADLINK PCIe-9852
│   ├── PCIe_9852_2CH_INIT.m
│   ├── PCIe_9852_2CH_GIGAGET.m
│   └── ...
│
├── core/                      # Основная логика съёмки и анализа данных
│   └── cr_get_reflectograms_ch1.m
│
├── hardware/                  # Работа с внешними устройствами (COM-порты, TBOX, CLOCKGEN)
│   ├── GetTBOX.m
│   ├── GetCLOCKGEN.m
│   ├── GetComPorts.m
│   ├── ComGet.m
│   ├── ComSet.m
│   └── SerialLib.m
│
├── test_data/                 # Результаты экспериментов (структура папок auto)
│
├── main_CR_test.m             # Главный скрипт запуска температурного эксперимента
├── Compare_results.m          # Сравнение и корреляция разных экспериментов
├── fix_CR_experiment_Fs.m     # Утилита для пересчёта оси z при изменённой Fs
│
└── README.md                  # (Этот файл)
```

---

## <a name="workflow"></a>3. Основные сценарии работы

### Быстрый старт

1. **Подключи все приборы:**

   * TBOX (термоконтроль), CLOCKGEN (тактовый генератор), ADLINK PCIe-9852 (АЦП).
   * Убедись, что все устройства определяются как COM-порты.

2. **Запусти MATLAB и добавь корневую папку проекта в path. Установи необходимые параметры в начале main_CR_test кода**

3. **Запусти эксперимент:**

   ```matlab
   main_CR_test   % или main_CR_temperature_sweep
   ```

   Следуй подсказкам в комментариях main кода и консоли — укажи параметры, диапазон температур, путь сохранения данных.

4. **Для повторного анализа или пересчёта оси z (например, если Fs изменилась):**

   ```matlab
   fix_CR_experiment_Fs('test_data/CR13/2024-08-29_1350', 100e6)
   ```

5. **Для сравнения двух экспериментов:**

   ```matlab
   Compare_results
   ```

   Выбери две папки с экспериментами и интерактивно укажи диапазон анализа на графике.

---

## <a name="hardware"></a>4. Управление оборудованием

### Поиск и инициализация устройств

* **GetTBOX:** Найти и вернуть порт термоконтроллера (по сигнатуре 'TBox33').
* **GetCLOCKGEN:** Найти и вернуть порт тактогенератора (по сигнатуре 'CLKGEN').
* **GetComPorts:** Получить список всех доступных COM‑портов.

### Пример:

```matlab
tbox = GetTBOX();      % Поиск TBOX
clkg = GetCLOCKGEN();  % Поиск CLOCKGEN
```

### Чтение/запись регистров

* **ComGet(port, reg):** Считать значение регистра.
* **ComSet(port, reg, value):** Записать значение в регистр.

### Пример:

```matlab
cur_temp = ComGet(tbox, 20);      % Прочитать реальную температуру лазера
ComSet(clkg, 50, 20);             % Установить длину импульса
```

**Подробно о регистрах см. ниже**.

---

## <a name="acquire"></a>5. Съёмка и обработка данных

### Основной модуль съёмки

* **cr\_get\_reflectograms\_ch1(N, L\_m, adc, opts)**
  Снимает N рефлектограмм заданной длины (L\_m, в метрах) с канала CH0.
  Использует автоматическую проверку качества и повторяет попытки при плохих данных.

**Важные параметры:**

* Fs — частота дискретизации (100e6 или 200e6).
* n\_eff — эффективный показатель преломления (обычно 1.468).
* sync\_ch — номер синхроканала (по умолчанию 0).

### Главный цикл температурного сканирования

* **main\_CR\_test.m**
  Автоматически проходит по диапазону температур, для каждой снимает пачку рефлектограмм, контролирует стабилизацию и точность установки температуры, сохраняет все промежуточные и итоговые данные.

**Результаты сохраняются** в `test_data/CRxx/YYYY-MM-DD_HHMM`.

---

## <a name="analysis"></a>6. Обработка и сравнение экспериментов

* **Compare\_results.m**
  Позволяет интерактивно сравнить результаты двух экспериментов (например, до и после воздействия), построить тепловую карту корреляций по средним трассам, сохранить итоговые графики и матрицы.

* **fix\_CR\_experiment\_Fs.m**
  Утилита для пересчёта оси z во всех матфайлах эксперимента под фактическую Fs (если после эксперимента выяснилось, что частота была не той).

---

## <a name="utils"></a>7. Утилиты и полезные скрипты

* **fix\_CR\_experiment\_Fs.m** — автоматический пересчёт оси z и тепловой карты, если частота дискретизации отличалась от плановой.
* **Вспомогательные функции** внутри Compare\_results (load\_experiment\_data\_means, plot\_correlation\_heatmap) помогают анализировать и строить сводные графики по данным.

---

## <a name="faq"></a>8. FAQ / Полезные формулы

### Шаг по дальности для одного отсчёта АЦП

dz = c / (2 \* n\_eff \* Fs)
где c = 299792458 м/с

**Типовые значения:**

* Fs = 200 МГц  → dz ≈ 0.51 м/отсчёт
* Fs = 100 МГц  → dz ≈ 1.02 м/отсчёт

### Температурные лазерные «попугаи» (регистр r0, r80):

* при r80 = 3: 1 попугай = 0.0004 °C
* при r80 = 4: 1 попугай = 0.0002 °C
* Формула: 1 попугай = 0.0004 × 2^(3 – r80) °C

### Часто используемые регистры

| Устройство | Регистр | Описание                        | Операции      |
| :--------- | :------ | :------------------------------ | :------------ |
| TBOX       | 0       | Установка температуры лазера    | ComGet/ComSet |
| TBOX       | 20      | Текущая температура лазера      | ComGet        |
| TBOX       | 30      | Температура всего термобокса    | ComGet        |
| TBOX       | 10      | Установка температуры термобокса| ComGet/ComSet |
| TBOX       | 61      | Статус/ошибка температуры       | ComGet        |
| TBOX       | 80      | Точность температуры лазера     | ComGet/ComSet |
| TBOX       | 90      | Точность температуры термобокса | ComGet/ComSet |
| CLOCKGEN   | 50      | Длина импульса (дискреты)       | ComGet/ComSet |
| CLOCKGEN   | 53      | Частота повторения, Гц          | ComGet/ComSet |
| CLOCKGEN   | 56      | RR-1 (предделитель, Fs)         | ComGet        |

---

## <a name="authors"></a>9. Авторы и поддержка

**Проект и автоматизация:** https://github.com/liya243
**Базовые библиотеки:** [ADLINK Technology Inc.](https://www.adlinktech.com/)

**Вопросы и баги:**

* Telegram: @aslan_monahov
* Issues и pull‑requests приветствуются!
